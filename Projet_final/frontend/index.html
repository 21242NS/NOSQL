<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker - Console</title>
    <style>
        :root {
            color-scheme: light dark;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        body {
            margin: 0;
            display: flex;
            min-height: 100vh;
            background: #1f2933;
            color: #f5f7fa;
        }
        .app {
            display: flex;
            width: 100%;
        }
        aside {
            width: 280px;
            border-right: 1px solid rgba(255,255,255,0.12);
            padding: 1.5rem;
            background: #111b27;
            box-sizing: border-box;
        }
        main {
            flex: 1;
            padding: 2rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        h1, h2, h3 {
            margin: 0 0 1rem;
            font-weight: 600;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        button:hover {
            background: #2563eb;
        }
        button.secondary {
            background: #4b5563;
        }
        ul.user-list {
            list-style: none;
            padding: 0;
            margin: 1.5rem 0 0;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }
        ul.user-list li {
            padding: 0.65rem 0.75rem;
            border-radius: 6px;
            background: rgba(255,255,255,0.04);
            cursor: pointer;
            transition: transform 0.1s ease, background 0.2s ease;
        }
        ul.user-list li:hover {
            transform: translateY(-1px);
            background: rgba(59,130,246,0.25);
        }
        ul.user-list li.active {
            background: rgba(59,130,246,0.4);
        }
        .category-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0 0;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }
        .category-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            padding: 0.65rem 0.75rem;
            border-radius: 6px;
            background: rgba(255,255,255,0.04);
        }
        .category-list li.category-empty {
            justify-content: center;
            background: transparent;
        }
        .category-list li header {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        .category-list li strong {
            font-size: 0.95rem;
        }
        .category-actions {
            display: flex;
            gap: 0.4rem;
        }
        .card {
            background: rgba(17,27,39,0.85);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }
        .card p {
            margin: 0.35rem 0;
        }
        .muted {
            color: rgba(255,255,255,0.6);
        }
        .badge {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 999px;
            background: rgba(59,130,246,0.25);
            font-size: 0.75rem;
            margin-right: 0.35rem;
        }
        .transactions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .subnav {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .subnav button {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            color: inherit;
            padding: 0.5rem 0.9rem;
        }
        .subnav button.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        .transaction-item {
            background: rgba(15,23,42,0.85);
            border-radius: 10px;
            padding: 0.85rem;
            border-left: 4px solid rgba(59,130,246,0.55);
        }
        .transaction-item.debit {
            border-left-color: #f97316;
        }
        .transaction-actions {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }
        dialog {
            border: none;
            border-radius: 12px;
            padding: 1.5rem;
            background: #111b27;
            color: inherit;
            max-width: 420px;
            width: 100%;
        }
        dialog::backdrop {
            background: rgba(15,23,42,0.75);
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        label {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            font-size: 0.9rem;
        }
        input, textarea, select {
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(15,23,42,0.65);
            color: inherit;
            padding: 0.6rem;
        }
        .actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            border: 1px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
        }
        .report-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
            align-items: flex-end;
        }
        .report-controls label {
            flex: 1;
            min-width: 180px;
        }
        .report-status {
            margin-top: 1rem;
        }
        .table-wrapper {
            overflow-x: auto;
            margin-top: 1.25rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead {
            background: rgba(255,255,255,0.04);
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        tbody tr:last-child td {
            border-bottom: none;
        }
        @media (max-width: 900px) {
            body { flex-direction: column; }
            aside { width: 100%; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.12); }
            main { padding: 1.25rem; }
        }
    </style>
</head>
<body>
    <div class="app">
        <aside>
            <h2>Utilisateurs</h2>
            <button id="open-add-user">Ajouter</button>
            <ul id="user-list" class="user-list"></ul>
        </aside>
        <main>
            <nav class="subnav">
                <button type="button" data-section="users" class="active">Utilisateurs</button>
                <button type="button" data-section="categories">Catégories</button>
                <button type="button" data-section="reports">Rapports</button>
            </nav>
            <section id="user-overview" class="card">
                <h1>Console de test</h1>
                <p class="muted">
                    Sélectionne un utilisateur pour afficher ses informations et enregistrer de nouvelles transactions.
                    Utilise le bouton « Ajouter » pour créer un profil de test.
                </p>
            </section>
            <section id="user-details" class="card" hidden>
                <header style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
                    <div>
                        <h2 id="user-name">Utilisateur</h2>
                        <p id="user-email" class="muted"></p>
                    </div>
                    <div style="display:flex;gap:0.5rem;">
                        <button id="open-edit-user" class="secondary" disabled>Modifier</button>
                        <button id="open-add-transaction">Ajouter une transaction</button>
                        <button id="delete-user" class="secondary">Supprimer</button>
                    </div>
                </header>
                <div id="user-meta">
                    <p><span class="badge">Téléphone</span><span id="user-phone">-</span></p>
                    <p><span class="badge">Créances</span><span id="user-creances">0</span></p>
                    <p><span class="badge">Dettes</span><span id="user-dettes">0</span></p>
                    <p><span class="badge">Argent récolté</span><span id="user-argent">0</span></p>
                    <p class="muted" style="margin-top:0.75rem;">
                        <strong>Créé le</strong> <span id="user-created"></span>
                        &nbsp;•&nbsp;<strong>Mis à jour</strong> <span id="user-updated"></span>
                    </p>
                </div>
                <div>
                    <h3>Transactions</h3>
                    <div id="transactions" class="transactions"></div>
                </div>
            </section>
            <section id="category-section" class="card">
                <header style="display:flex;justify-content:space-between;align-items:center;">
                    <h2>Catégories</h2>
                    <button id="open-add-category">Ajouter</button>
                </header>
                <p class="muted">Gère les catégories utilisées lors de la création ou modification d'une transaction.</p>
                <ul id="category-list" class="category-list"></ul>
            </section>
            <section id="reports-section" class="card">
                <header>
                    <h2>Rapports financiers</h2>
                </header>
                <p class="muted">
                    Sélectionne une période, puis génère un rapport pour chaque utilisateur afin de visualiser leurs créances,
                    dettes et l'argent récolté.
                </p>
                <form id="report-form" class="report-controls">
                    <label>Période début
                        <input type="datetime-local" name="period_start" required>
                    </label>
                    <label>Période fin
                        <input type="datetime-local" name="period_end" required>
                    </label>
                    <button type="submit" id="generate-reports">Générer les rapports</button>
                </form>
                <p id="report-status" class="muted report-status"></p>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>Créances</th>
                                <th>Dettes</th>
                                <th>Argent récolté</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body">
                            <tr>
                                <td colspan="4" class="muted">Aucun rapport généré pour le moment.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <dialog id="user-dialog">
        <form id="user-form">
            <h2>Nouvel utilisateur</h2>
            <label>Prénom
                <input type="text" name="first_name" required>
            </label>
            <label>Nom
                <input type="text" name="last_name" required>
            </label>
            <label>Email
                <input type="email" name="email" required>
            </label>
            <label>Téléphone
                <input type="text" name="phone">
            </label>
            <label>Créances initiales
                <input type="number" step="0.01" min="0" name="creances" value="0">
            </label>
            <label>Dettes initiales
                <input type="number" step="0.01" min="0" name="dettes" value="0">
            </label>
            <label>Argent récolté
                <input type="number" step="0.01" name="argent_recolte" placeholder="Laisse vide pour auto-calcul">
            </label>
            <div class="actions">
                <button type="button" class="secondary" id="cancel-user">Annuler</button>
                <button type="submit">Enregistrer</button>
            </div>
        </form>
    </dialog>

    <dialog id="transaction-dialog">
        <form id="transaction-form">
            <h2>Ajouter une transaction</h2>
            <label>Type de relation
                <select name="relation_type" required>
                    <option value="creance">Créance</option>
                    <option value="dette">Dette</option>
                </select>
            </label>
            <label>Sens de la transaction
                <select name="type" required>
                    <option value="credit">Crédit (ajout)</option>
                    <option value="debit">Débit (retrait)</option>
                </select>
            </label>
            <label>Montant (€)
                <input type="number" name="amount" min="0" step="0.01" required>
            </label>
            <label>Description
                <textarea name="description" rows="3" placeholder="Ex: Remboursement partiel"></textarea>
            </label>
            <label>Catégorie
                <select name="category_id" id="transaction-category">
                    <option value="">Sans catégorie</option>
                </select>
            </label>
            <label>Date
                <input type="datetime-local" name="date">
            </label>
            <div class="actions">
                <button type="button" class="secondary" id="cancel-transaction">Annuler</button>
                <button type="submit">Valider</button>
            </div>
        </form>
    </dialog>

    <dialog id="category-dialog">
        <form id="category-form">
            <h2>Nouvelle catégorie</h2>
            <label>Nom
                <input type="text" name="name" required>
            </label>
            <label>Description
                <textarea name="description" rows="3" placeholder="Détail optionnel"></textarea>
            </label>
            <div class="actions">
                <button type="button" class="secondary" id="cancel-category">Annuler</button>
                <button type="submit">Enregistrer</button>
            </div>
        </form>
    </dialog>

    <script>
        const API_BASE_URL = (window.API_BASE_URL) || "http://localhost:5001/api";

        const state = {
            users: [],
            selectedUserId: null,
            currentUser: null,
            transactions: [],
            categories: [],
            reports: [],
        };

        const userListEl = document.getElementById("user-list");
        const userDetailsSection = document.getElementById("user-details");
        const userOverview = document.getElementById("user-overview");
        const transactionsContainer = document.getElementById("transactions");
        const categoryListEl = document.getElementById("category-list");
        const userDialog = document.getElementById("user-dialog");
        const userForm = document.getElementById("user-form");
        const transactionDialog = document.getElementById("transaction-dialog");
        const transactionForm = document.getElementById("transaction-form");
        const transactionTitleEl = transactionDialog.querySelector("h2");
        const transactionSubmitButton = transactionDialog.querySelector('button[type="submit"]');
        const deleteUserButton = document.getElementById("delete-user");
        const categoryDialog = document.getElementById("category-dialog");
        const categoryForm = document.getElementById("category-form");
        const categoryTitleEl = categoryDialog.querySelector("h2");
        const categorySubmitButton = categoryDialog.querySelector('button[type="submit"]');
        const cancelCategoryButton = document.getElementById("cancel-category");
        const openAddCategoryButton = document.getElementById("open-add-category");
        const reportForm = document.getElementById("report-form");
        const reportStatusEl = document.getElementById("report-status");
        const reportTableBody = document.getElementById("report-table-body");
        const reportSubmitButton = document.getElementById("generate-reports");
        const openAddUserButton = document.getElementById("open-add-user");
        const editUserButton = document.getElementById("open-edit-user");
        const userTitleEl = userDialog.querySelector("h2");
        const userSubmitButton = userDialog.querySelector('button[type="submit"]');
        const categorySection = document.getElementById("category-section");
        const reportsSection = document.getElementById("reports-section");
        const subnavButtons = document.querySelectorAll(".subnav [data-section]");
        let activeSection = "users";

        if (openAddUserButton) {
            openAddUserButton.addEventListener("click", () => openUserDialog("create"));
        }

        if (editUserButton) {
            editUserButton.addEventListener("click", () => {
                if (!state.currentUser) {
                    return;
                }
                openUserDialog("edit", state.currentUser);
            });
        }

        document.getElementById("cancel-user").addEventListener("click", () => userDialog.close());

        document.getElementById("open-add-transaction").addEventListener("click", () => {
            if (!state.selectedUserId) return;
            openTransactionDialog("create");
        });

        document.getElementById("cancel-transaction").addEventListener("click", () => transactionDialog.close());
        deleteUserButton.addEventListener("click", handleDeleteUser);
        openAddCategoryButton.addEventListener("click", () => openCategoryDialog("create"));
        cancelCategoryButton.addEventListener("click", () => categoryDialog.close());
        subnavButtons.forEach((button) => {
            button.addEventListener("click", () => {
                const target = button.dataset.section;
                if (!target) {
                    return;
                }
                setActiveSection(target);
            });
        });

        userForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const mode = userForm.dataset.mode || "create";
            const userId = userForm.dataset.userId || "";
            const formData = new FormData(userForm);

            const payload = {
                first_name: (formData.get("first_name") || "").trim(),
                last_name: (formData.get("last_name") || "").trim(),
                email: (formData.get("email") || "").trim(),
                phone: (formData.get("phone") || "").trim(),
            };

            payload.creances = parseNumberOrZero(formData.get("creances"));
            payload.dettes = parseNumberOrZero(formData.get("dettes"));

            const argentRecolteInput = formData.get("argent_recolte");
            let argentRecolteValue = argentRecolteInput ? parseNumberOrZero(argentRecolteInput) : payload.creances - payload.dettes;

            const roundToTwo = (value) => Math.round(value * 100) / 100;
            payload.creances = roundToTwo(payload.creances);
            payload.dettes = roundToTwo(payload.dettes);
            payload.argent_recolte = roundToTwo(argentRecolteValue);
            payload.phone = payload.phone || null;

            const timestamp = new Date().toISOString();

            try {
                if (mode === "edit") {
                    if (!userId) {
                        throw new Error("Utilisateur introuvable.");
                    }
                    payload.updated_at = timestamp;
                    await apiFetch(`/users/${userId}`, {
                        method: "PUT",
                        body: JSON.stringify(payload),
                    });
                    userDialog.close();
                    await refreshCurrentUser();
                } else {
                    payload.created_at = timestamp;
                    payload.updated_at = timestamp;
                    const created = await apiFetch("/users", {
                        method: "POST",
                        body: JSON.stringify(payload),
                    });
                    userDialog.close();
                    await loadUsers();
                    if (created && created._id) {
                        await selectUser(created._id);
                    }
                }
            } catch (error) {
                alert("Erreur lors de l'enregistrement : " + error.message);
            }
        });

        function openUserDialog(mode, user = null) {
            userForm.reset();
            userForm.dataset.mode = mode;
            userForm.dataset.userId = user?._id || "";

            if (userTitleEl) {
                userTitleEl.textContent = mode === "edit" ? "Modifier l'utilisateur" : "Nouvel utilisateur";
            }
            if (userSubmitButton) {
                userSubmitButton.textContent = mode === "edit" ? "Enregistrer les modifications" : "Enregistrer";
            }

            if (mode === "edit" && user) {
                userForm.elements.first_name.value = user.first_name || "";
                userForm.elements.last_name.value = user.last_name || "";
                userForm.elements.email.value = user.email || "";
                userForm.elements.phone.value = user.phone || "";
                userForm.elements.creances.value = parseNumberOrZero(user.creances);
                userForm.elements.dettes.value = parseNumberOrZero(user.dettes);
                userForm.elements.argent_recolte.value =
                    user.argent_recolte !== undefined && user.argent_recolte !== null
                        ? parseNumberOrZero(user.argent_recolte)
                        : "";
            }

            userDialog.showModal();
        }

        transactionsContainer.addEventListener("click", (event) => {
            const target = event.target;
            if (target.closest(".transaction-edit")) {
                const button = target.closest(".transaction-edit");
                const transactionId = button.dataset.transactionId;
                const transaction = state.transactions.find((t) => t._id === transactionId);
                if (transaction) {
                    openTransactionDialog("edit", transaction);
                }
            } else if (target.closest(".transaction-delete")) {
                const button = target.closest(".transaction-delete");
                const transactionId = button.dataset.transactionId;
                handleDeleteTransaction(transactionId);
            }
        });

        categoryForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const mode = categoryForm.dataset.mode || "create";
            const formData = new FormData(categoryForm);
            const payload = {
                name: (formData.get("name") || "").trim(),
                description: (formData.get("description") || "").trim() || null,
            };

            if (!payload.name) {
                alert("Le nom de la catégorie est requis.");
                return;
            }

            try {
                if (mode === "edit") {
                    const categoryId = categoryForm.dataset.categoryId;
                    await apiFetch(`/categories/${categoryId}`, {
                        method: "PUT",
                        body: JSON.stringify(payload),
                    });
                } else {
                    await apiFetch("/categories", {
                        method: "POST",
                        body: JSON.stringify(payload),
                    });
                }
                categoryDialog.close();
                await loadCategories();
            } catch (error) {
                alert("Impossible d'enregistrer la catégorie : " + error.message);
            }
        });

        categoryListEl.addEventListener("click", (event) => {
            const button = event.target.closest("button[data-action]");
            if (!button) {
                return;
            }
            const categoryId = button.dataset.categoryId;
            const category = state.categories.find((c) => c._id === categoryId);
            if (button.dataset.action === "edit" && category) {
                openCategoryDialog("edit", category);
            } else if (button.dataset.action === "delete" && categoryId) {
                handleDeleteCategory(categoryId);
            }
        });

        transactionForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            if (!state.selectedUserId) return;

            const mode = transactionForm.dataset.mode || "create";
            const formData = new FormData(transactionForm);
            const transactionPayload = collectTransactionFormData(formData);

            try {
                if (mode === "edit") {
                    const transactionId = transactionForm.dataset.transactionId;
                    const response = await apiFetch(`/transactions/${transactionId}`, {
                        method: "PUT",
                        body: JSON.stringify(transactionPayload),
                    });
                    if (response && response.user) {
                        state.currentUser = response.user;
                        state.users = state.users.map((u) => (u._id === response.user._id ? response.user : u));
                    }
                } else {
                    if (!state.currentUser) {
                        alert("Utilisateur introuvable en mémoire.");
                        return;
                    }
                    const payload = { transaction: transactionPayload };
                    const response = await apiFetch(`/users/${state.selectedUserId}/transaction`, {
                        method: "PUT",
                        body: JSON.stringify(payload),
                    });
                    if (response && response.user) {
                        state.currentUser = response.user;
                        state.users = state.users.map((u) => (u._id === response.user._id ? response.user : u));
                    }
                }

                transactionDialog.close();
                await refreshCurrentUser();
            } catch (error) {
                alert("Erreur lors de l'enregistrement : " + error.message);
            }
        });

        if (reportForm) {
            reportForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                const formData = new FormData(reportForm);
                const periodStartValue = formData.get("period_start");
                const periodEndValue = formData.get("period_end");

                if (!periodStartValue || !periodEndValue) {
                    alert("Veuillez renseigner les deux dates de la période.");
                    return;
                }

                const startDate = new Date(periodStartValue);
                const endDate = new Date(periodEndValue);
                if (Number.isNaN(startDate.getTime()) || Number.isNaN(endDate.getTime())) {
                    alert("Format de date invalide.");
                    return;
                }
                if (startDate > endDate) {
                    alert("La date de début doit être antérieure à la date de fin.");
                    return;
                }

                const period_start = startDate.toISOString();
                const period_end = endDate.toISOString();

                if (reportSubmitButton) {
                    reportSubmitButton.disabled = true;
                    reportSubmitButton.textContent = "Génération...";
                }
                if (reportStatusEl) {
                    reportStatusEl.textContent = "Génération des rapports en cours...";
                }

                try {
                    if (!state.users.length) {
                        await loadUsers();
                    }

                    const reports = [];
                    for (const user of state.users) {
                        try {
                            const response = await apiFetch(`/reports/generate`, {
                                method: "POST",
                                body: JSON.stringify({
                                    user_id: user._id,
                                    period_start,
                                    period_end,
                                }),
                            });
                            if (response && response.report) {
                                reports.push({
                                    user,
                                    report: response.report,
                                });
                            }
                        } catch (error) {
                            console.error(`Erreur pour l'utilisateur ${user._id} :`, error);
                        }
                    }

                    state.reports = reports;
                    renderReportTable();
                    if (reportStatusEl) {
                        if (reports.length) {
                            const periodStartLabel = formatDate(period_start);
                            const periodEndLabel = formatDate(period_end);
                            reportStatusEl.textContent = `Rapports générés (${periodStartLabel} → ${periodEndLabel}) pour ${reports.length} utilisateur(s).`;
                        } else {
                            reportStatusEl.textContent = "Aucun rapport généré pour cette période.";
                        }
                    }
                } catch (error) {
                    alert("Impossible de générer les rapports : " + error.message);
                    if (reportStatusEl) {
                        reportStatusEl.textContent = "";
                    }
                } finally {
                    if (reportSubmitButton) {
                        reportSubmitButton.disabled = false;
                        reportSubmitButton.textContent = "Générer les rapports";
                    }
                }
            });
        }

        function setActiveSection(section) {
            activeSection = section;
            subnavButtons.forEach((button) => {
                button.classList.toggle("active", button.dataset.section === section);
            });

            const showUsers = section === "users";
            const showCategories = section === "categories";
            const showReports = section === "reports";

            if (categorySection) {
                categorySection.hidden = !showCategories;
            }
            if (reportsSection) {
                reportsSection.hidden = !showReports;
            }

            if (showUsers) {
                updateUserDetails(state.currentUser);
            } else {
                userOverview.hidden = true;
                userDetailsSection.hidden = true;
                if (editUserButton) {
                    editUserButton.disabled = true;
                }
            }

            if (showCategories && !state.categories.length) {
                loadCategories().catch((error) => console.error(error));
            }
        }

        async function loadUsers() {
            const users = await apiFetch("/users");
            state.users = users;
            renderUserList();
        }

        async function loadCategories() {
            const categories = await apiFetch("/categories");
            state.categories = categories;
            renderCategoryList();
            populateCategorySelect();
            if (state.transactions.length) {
                renderTransactions(state.transactions);
            }
        }

        function renderUserList() {
            userListEl.innerHTML = "";
            if (!state.users.length) {
                const empty = document.createElement("li");
                empty.className = "muted";
                empty.textContent = "Aucun utilisateur";
                empty.style.cursor = "default";
                userListEl.appendChild(empty);
                if (activeSection === "users") {
                    userDetailsSection.hidden = true;
                    userOverview.hidden = false;
                } else {
                    userDetailsSection.hidden = true;
                    userOverview.hidden = true;
                }
                renderTransactions([]);
                return;
            }

            state.users.forEach((user) => {
                const li = document.createElement("li");
                li.textContent = `${user.first_name ?? ""} ${user.last_name ?? ""}`.trim() || user.email;
                if (user._id === state.selectedUserId) {
                    li.classList.add("active");
                }
                li.addEventListener("click", () => selectUser(user._id));
                userListEl.appendChild(li);
            });
        }

        function renderCategoryList() {
            categoryListEl.innerHTML = "";
            if (!state.categories.length) {
                const empty = document.createElement("li");
                empty.className = "category-empty muted";
                empty.textContent = "Aucune catégorie";
                categoryListEl.appendChild(empty);
                return;
            }

            state.categories.forEach((category) => {
                const li = document.createElement("li");
                const info = document.createElement("header");
                const nameEl = document.createElement("strong");
                nameEl.textContent = category.name || "Sans nom";
                info.appendChild(nameEl);
                if (category.description) {
                    const descriptionEl = document.createElement("span");
                    descriptionEl.className = "muted";
                    descriptionEl.textContent = category.description;
                    info.appendChild(descriptionEl);
                }
                li.appendChild(info);

                const actions = document.createElement("div");
                actions.className = "category-actions";

                const editButton = document.createElement("button");
                editButton.type = "button";
                editButton.className = "secondary";
                editButton.dataset.action = "edit";
                editButton.dataset.categoryId = category._id;
                editButton.textContent = "Modifier";
                actions.appendChild(editButton);

                const deleteButton = document.createElement("button");
                deleteButton.type = "button";
                deleteButton.className = "secondary";
                deleteButton.dataset.action = "delete";
                deleteButton.dataset.categoryId = category._id;
                deleteButton.textContent = "Supprimer";
                actions.appendChild(deleteButton);

                li.appendChild(actions);
                categoryListEl.appendChild(li);
            });
        }

        function renderReportTable() {
            if (!reportTableBody) {
                return;
            }

            reportTableBody.innerHTML = "";

            if (!state.reports.length) {
                const emptyRow = document.createElement("tr");
                const emptyCell = document.createElement("td");
                emptyCell.colSpan = 4;
                emptyCell.className = "muted";
                emptyCell.textContent = "Aucun rapport généré pour le moment.";
                emptyRow.appendChild(emptyCell);
                reportTableBody.appendChild(emptyRow);
                return;
            }

            state.reports.forEach(({ user, report }) => {
                const row = document.createElement("tr");
                const fullName =
                    `${user.first_name ?? ""} ${user.last_name ?? ""}`.trim() ||
                    user.email ||
                    "Utilisateur";

                const creancesValue = parseNumberOrZero(report.total_credit ?? report.creances);
                const dettesValue = parseNumberOrZero(report.total_debit ?? report.dettes);
                const collecteValue = parseNumberOrZero(report.net_balance ?? report.argent_recolte);

                const nameCell = document.createElement("td");
                nameCell.textContent = fullName;
                const creancesCell = document.createElement("td");
                creancesCell.textContent = formatCurrency(creancesValue);
                const dettesCell = document.createElement("td");
                dettesCell.textContent = formatCurrency(dettesValue);
                const collecteCell = document.createElement("td");
                collecteCell.textContent = formatCurrency(collecteValue);

                row.appendChild(nameCell);
                row.appendChild(creancesCell);
                row.appendChild(dettesCell);
                row.appendChild(collecteCell);

                reportTableBody.appendChild(row);
            });
        }

        async function selectUser(userId) {
            state.selectedUserId = userId;
            renderUserList();
            await refreshCurrentUser();
        }

        async function refreshCurrentUser() {
            if (!state.selectedUserId) {
                state.currentUser = null;
                state.transactions = [];
                renderTransactions([]);
                updateUserDetails(null);
                return;
            }

            try {
                const [user, transactions] = await Promise.all([
                    apiFetch(`/users/${state.selectedUserId}`),
                    apiFetch(`/transactions?user_id=${encodeURIComponent(state.selectedUserId)}`),
                ]);

                state.currentUser = user;
                state.transactions = transactions;

                updateUserDetails(user);
                renderTransactions(transactions);

                state.users = state.users.map((u) => (u._id === user._id ? user : u));
                renderUserList();
            } catch (error) {
                alert("Impossible de charger l'utilisateur : " + error.message);
            }
        }

        function updateUserDetails(user) {
            const showUsers = activeSection === "users";
            if (!showUsers) {
                userDetailsSection.hidden = true;
                userOverview.hidden = true;
                if (editUserButton) {
                    editUserButton.disabled = true;
                }
                return;
            }

            if (!user) {
                userDetailsSection.hidden = true;
                userOverview.hidden = false;
                if (editUserButton) {
                    editUserButton.disabled = true;
                }
                return;
            }

            userDetailsSection.hidden = false;
            userOverview.hidden = true;
            if (editUserButton) {
                editUserButton.disabled = false;
            }

            document.getElementById("user-name").textContent =
                `${user.first_name ?? ""} ${user.last_name ?? ""}`.trim() || "Profil";
            document.getElementById("user-email").textContent = user.email || "Email inconnu";
            document.getElementById("user-phone").textContent = user.phone || "—";
            document.getElementById("user-creances").textContent = formatCurrency(user.creances);
            document.getElementById("user-dettes").textContent = formatCurrency(user.dettes);
            document.getElementById("user-argent").textContent = formatCurrency(user.argent_recolte);
            document.getElementById("user-created").textContent = formatDate(user.created_at);
            document.getElementById("user-updated").textContent = formatDate(user.updated_at);
        }

        function renderTransactions(transactions) {
            transactionsContainer.innerHTML = "";
            if (!transactions || !transactions.length) {
                const empty = document.createElement("div");
                empty.className = "empty-state";
                empty.textContent = "Aucune transaction enregistrée pour le moment.";
                transactionsContainer.appendChild(empty);
                return;
            }

            transactions.forEach((transaction) => {
                const item = document.createElement("div");
                item.className = `transaction-item ${transaction.type === "debit" ? "debit" : "credit"}`;
                const categoryLabel = getCategoryLabel(transaction.category_id);
                item.innerHTML = `
                    <strong>${(transaction.relation_type || "").toUpperCase()} • ${(transaction.type || "").toUpperCase()}</strong>
                    <p>Montant : ${formatCurrency(transaction.amount)}</p>
                    <p>Catégorie : ${categoryLabel ?? "—"}</p>
                    <p>${transaction.description ?? ""}</p>
                    <p class="muted">${formatDate(transaction.date)}</p>
                `;

                const actions = document.createElement("div");
                actions.className = "transaction-actions";
                const editButton = document.createElement("button");
                editButton.type = "button";
                editButton.className = "secondary transaction-edit";
                editButton.dataset.transactionId = transaction._id;
                editButton.textContent = "Modifier";
                actions.appendChild(editButton);
                const deleteButton = document.createElement("button");
                deleteButton.type = "button";
                deleteButton.className = "secondary transaction-delete";
                deleteButton.dataset.transactionId = transaction._id;
                deleteButton.textContent = "Supprimer";
                actions.appendChild(deleteButton);

                item.appendChild(actions);
                transactionsContainer.appendChild(item);
            });
        }

        function openTransactionDialog(mode, transaction = null) {
            transactionForm.reset();
            transactionForm.dataset.mode = mode;
            transactionForm.dataset.transactionId = transaction?._id || "";
            populateCategorySelect(transaction?.category_id || "");

            if (mode === "edit" && transaction) {
                transactionTitleEl.textContent = "Modifier la transaction";
                transactionSubmitButton.textContent = "Mettre à jour";
                transactionForm.elements.relation_type.value = transaction.relation_type || "creance";
                transactionForm.elements.type.value = transaction.type || "credit";
                transactionForm.elements.amount.value = parseNumberOrZero(transaction.amount);
                transactionForm.elements.description.value = transaction.description ?? "";
                transactionForm.elements.category_id.value = transaction.category_id ?? "";
                const dateValue = transaction.date ? new Date(transaction.date) : new Date();
                transactionForm.elements.date.value = toLocalInputDateTime(dateValue);
            } else {
                transactionTitleEl.textContent = "Nouvelle transaction";
                transactionSubmitButton.textContent = "Valider";
                const now = new Date();
                transactionForm.elements.date.value = toLocalInputDateTime(now);
            }

            transactionDialog.showModal();
        }

        function collectTransactionFormData(formData) {
            const amount = parseNumberOrZero(formData.get("amount"));
            const categoryIdRaw = formData.get("category_id") || "";

            const data = {
                relation_type: formData.get("relation_type"),
                type: formData.get("type"),
                amount,
                description: formData.get("description") || null,
                date: (() => {
                    const dateValue = formData.get("date");
                    return dateValue ? new Date(dateValue).toISOString() : new Date().toISOString();
                })(),
            };

            data.category_id = categoryIdRaw || null;

            return data;
        }

        function openCategoryDialog(mode, category = null) {
            categoryForm.reset();
            categoryForm.dataset.mode = mode;
            categoryForm.dataset.categoryId = category?._id || "";

            if (mode === "edit" && category) {
                categoryTitleEl.textContent = "Modifier la catégorie";
                categorySubmitButton.textContent = "Mettre à jour";
                categoryForm.elements.name.value = category.name || "";
                categoryForm.elements.description.value = category.description || "";
            } else {
                categoryTitleEl.textContent = "Nouvelle catégorie";
                categorySubmitButton.textContent = "Enregistrer";
            }

            categoryDialog.showModal();
        }

        async function handleDeleteCategory(categoryId) {
            const category = state.categories.find((c) => c._id === categoryId);
            const label = category ? (category.name || category._id) : "cette catégorie";
            const confirmation = window.confirm(`Supprimer ${label} ? Cette action est définitive.`);
            if (!confirmation) {
                return;
            }
            try {
                await apiFetch(`/categories/${categoryId}`, { method: "DELETE" });
                await loadCategories();
            } catch (error) {
                alert("Impossible de supprimer la catégorie : " + error.message);
            }
        }

        function populateCategorySelect(selectedId = null) {
            const select = transactionForm.elements.category_id;
            if (!select) {
                return;
            }
            const targetValue = selectedId !== null ? selectedId : select.value;
            select.innerHTML = "";

            const emptyOption = document.createElement("option");
            emptyOption.value = "";
            emptyOption.textContent = "Sans catégorie";
            select.appendChild(emptyOption);

            state.categories.forEach((category) => {
                const option = document.createElement("option");
                option.value = category._id;
                option.textContent = category.name || category._id;
                select.appendChild(option);
            });

            if (targetValue && [...select.options].some((option) => option.value === targetValue)) {
                select.value = targetValue;
            } else {
                select.value = "";
            }
        }

        function getCategoryLabel(categoryId) {
            if (!categoryId) {
                return null;
            }
            const category = state.categories.find((c) => c._id === categoryId);
            return category ? category.name || category._id : categoryId;
        }

        async function apiFetch(path, options = {}) {
            const response = await fetch(`${API_BASE_URL}${path}`, {
                headers: { "Content-Type": "application/json" },
                ...options,
            });
            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({}));
                const message = errorBody.error || response.statusText || "Erreur réseau";
                throw new Error(message);
            }
            return response.json();
        }

        function parseNumberOrZero(value) {
            const parsed = Number.parseFloat(value);
            return Number.isFinite(parsed) ? parsed : 0;
        }

        function formatCurrency(value) {
            const number = parseNumberOrZero(value);
            return new Intl.NumberFormat("fr-FR", { style: "currency", currency: "EUR" }).format(number);
        }

        function formatDate(value) {
            if (!value) return "—";
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return value;
            return date.toLocaleString("fr-FR");
        }

        function toLocalInputDateTime(date) {
            const pad = (n) => n.toString().padStart(2, "0");
            const yyyy = date.getFullYear();
            const mm = pad(date.getMonth() + 1);
            const dd = pad(date.getDate());
            const hh = pad(date.getHours());
            const min = pad(date.getMinutes());
            return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
        }

        async function handleDeleteUser() {
            if (!state.selectedUserId) {
                return;
            }
            const user = state.currentUser;
            const label = user
                ? `${user.first_name ?? ""} ${user.last_name ?? ""}`.trim() || user.email || "cet utilisateur"
                : "cet utilisateur";
            const confirmation = window.confirm(`Supprimer ${label} ? Cette action est définitive.`);
            if (!confirmation) {
                return;
            }
            try {
                await apiFetch(`/users/${state.selectedUserId}`, {
                    method: "DELETE",
                });
                state.selectedUserId = null;
                state.currentUser = null;
                state.transactions = [];
                await loadUsers();
                updateUserDetails(null);
                renderTransactions([]);
            } catch (error) {
                alert("Impossible de supprimer l'utilisateur : " + error.message);
            }
        }

        async function handleDeleteTransaction(transactionId) {
            if (!transactionId || !state.selectedUserId) {
                return;
            }
            const confirmation = window.confirm("Supprimer cette transaction ? Cette action est définitive.");
            if (!confirmation) {
                return;
            }
            try {
                const response = await apiFetch(`/transactions/${transactionId}`, {
                    method: "DELETE",
                });

                if (response && response.user) {
                    state.currentUser = response.user;
                    state.users = state.users.map((u) => (u._id === response.user._id ? response.user : u));
                    updateUserDetails(response.user);
                }

                state.transactions = state.transactions.filter((t) => t._id !== transactionId);
                renderTransactions(state.transactions);
            } catch (error) {
                alert("Impossible de supprimer la transaction : " + error.message);
            }
        }

        setActiveSection(activeSection);
        renderReportTable();

        Promise.all([loadUsers(), loadCategories()]).catch((error) => {
            console.error(error);
            alert("Impossible de charger les données initiales : " + error.message);
        });
    </script>
</body>
</html>
