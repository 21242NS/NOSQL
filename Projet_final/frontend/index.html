<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker - Console</title>
    <style>
        :root {
            color-scheme: light dark;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        body {
            margin: 0;
            display: flex;
            min-height: 100vh;
            background: #1f2933;
            color: #f5f7fa;
        }
        .app {
            display: flex;
            width: 100%;
        }
        aside {
            width: 280px;
            border-right: 1px solid rgba(255,255,255,0.12);
            padding: 1.5rem;
            background: #111b27;
            box-sizing: border-box;
        }
        main {
            flex: 1;
            padding: 2rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        h1, h2, h3 {
            margin: 0 0 1rem;
            font-weight: 600;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        button:hover {
            background: #2563eb;
        }
        button.secondary {
            background: #4b5563;
        }
        ul.user-list {
            list-style: none;
            padding: 0;
            margin: 1.5rem 0 0;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }
        ul.user-list li {
            padding: 0.65rem 0.75rem;
            border-radius: 6px;
            background: rgba(255,255,255,0.04);
            cursor: pointer;
            transition: transform 0.1s ease, background 0.2s ease;
        }
        ul.user-list li:hover {
            transform: translateY(-1px);
            background: rgba(59,130,246,0.25);
        }
        ul.user-list li.active {
            background: rgba(59,130,246,0.4);
        }
        .card {
            background: rgba(17,27,39,0.85);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }
        .card p {
            margin: 0.35rem 0;
        }
        .muted {
            color: rgba(255,255,255,0.6);
        }
        .badge {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 999px;
            background: rgba(59,130,246,0.25);
            font-size: 0.75rem;
            margin-right: 0.35rem;
        }
        .transactions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .transaction-item {
            background: rgba(15,23,42,0.85);
            border-radius: 10px;
            padding: 0.85rem;
            border-left: 4px solid rgba(59,130,246,0.55);
        }
        .transaction-item.debit {
            border-left-color: #f97316;
        }
        .transaction-actions {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }
        dialog {
            border: none;
            border-radius: 12px;
            padding: 1.5rem;
            background: #111b27;
            color: inherit;
            max-width: 420px;
            width: 100%;
        }
        dialog::backdrop {
            background: rgba(15,23,42,0.75);
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        label {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            font-size: 0.9rem;
        }
        input, textarea, select {
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(15,23,42,0.65);
            color: inherit;
            padding: 0.6rem;
        }
        .actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            border: 1px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
        }
        @media (max-width: 900px) {
            body { flex-direction: column; }
            aside { width: 100%; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.12); }
            main { padding: 1.25rem; }
        }
    </style>
</head>
<body>
    <div class="app">
        <aside>
            <h2>Utilisateurs</h2>
            <button id="open-add-user">Ajouter</button>
            <ul id="user-list" class="user-list"></ul>
        </aside>
        <main>
            <section id="user-overview" class="card">
                <h1>Console de test</h1>
                <p class="muted">
                    Sélectionne un utilisateur pour afficher ses informations et enregistrer de nouvelles transactions.
                    Utilise le bouton « Ajouter » pour créer un profil de test.
                </p>
            </section>
            <section id="user-details" class="card" hidden>
                <header style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
                    <div>
                        <h2 id="user-name">Utilisateur</h2>
                        <p id="user-email" class="muted"></p>
                    </div>
                    <div style="display:flex;gap:0.5rem;">
                        <button id="open-add-transaction">Ajouter une transaction</button>
                        <button id="delete-user" class="secondary">Supprimer</button>
                    </div>
                </header>
                <div id="user-meta">
                    <p><span class="badge">Téléphone</span><span id="user-phone">-</span></p>
                    <p><span class="badge">Créances</span><span id="user-creances">0</span></p>
                    <p><span class="badge">Dettes</span><span id="user-dettes">0</span></p>
                    <p><span class="badge">Argent récolté</span><span id="user-argent">0</span></p>
                    <p class="muted" style="margin-top:0.75rem;">
                        <strong>Créé le</strong> <span id="user-created"></span>
                        &nbsp;•&nbsp;<strong>Mis à jour</strong> <span id="user-updated"></span>
                    </p>
                </div>
                <div>
                    <h3>Transactions</h3>
                    <div id="transactions" class="transactions"></div>
                </div>
            </section>
        </main>
    </div>

    <dialog id="user-dialog">
        <form id="user-form">
            <h2>Nouvel utilisateur</h2>
            <label>Prénom
                <input type="text" name="first_name" required>
            </label>
            <label>Nom
                <input type="text" name="last_name" required>
            </label>
            <label>Email
                <input type="email" name="email" required>
            </label>
            <label>Téléphone
                <input type="text" name="phone">
            </label>
            <label>Créances initiales
                <input type="number" step="0.01" min="0" name="creances" value="0">
            </label>
            <label>Dettes initiales
                <input type="number" step="0.01" min="0" name="dettes" value="0">
            </label>
            <label>Argent récolté
                <input type="number" step="0.01" name="argent_recolte" placeholder="Laisse vide pour auto-calcul">
            </label>
            <div class="actions">
                <button type="button" class="secondary" id="cancel-user">Annuler</button>
                <button type="submit">Enregistrer</button>
            </div>
        </form>
    </dialog>

    <dialog id="transaction-dialog">
        <form id="transaction-form">
            <h2>Ajouter une transaction</h2>
            <label>Type de relation
                <select name="relation_type" required>
                    <option value="creance">Créance</option>
                    <option value="dette">Dette</option>
                </select>
            </label>
            <label>Sens de la transaction
                <select name="type" required>
                    <option value="credit">Crédit (ajout)</option>
                    <option value="debit">Débit (retrait)</option>
                </select>
            </label>
            <label>Montant (€)
                <input type="number" name="amount" min="0" step="0.01" required>
            </label>
            <label>Description
                <textarea name="description" rows="3" placeholder="Ex: Remboursement partiel"></textarea>
            </label>
            <label>Catégorie (ID Mongo optionnel)
                <input type="text" name="category_id" placeholder="5f... (optionnel)">
            </label>
            <label>Date
                <input type="datetime-local" name="date">
            </label>
            <div class="actions">
                <button type="button" class="secondary" id="cancel-transaction">Annuler</button>
                <button type="submit">Valider</button>
            </div>
        </form>
    </dialog>

    <script>
        const API_BASE_URL = (window.API_BASE_URL) || "http://localhost:5001/api";

        const state = {
            users: [],
            selectedUserId: null,
            currentUser: null,
            transactions: [],
        };

        const userListEl = document.getElementById("user-list");
        const userDetailsSection = document.getElementById("user-details");
        const userOverview = document.getElementById("user-overview");
        const transactionsContainer = document.getElementById("transactions");
        const userDialog = document.getElementById("user-dialog");
        const userForm = document.getElementById("user-form");
        const transactionDialog = document.getElementById("transaction-dialog");
        const transactionForm = document.getElementById("transaction-form");
        const transactionTitleEl = transactionDialog.querySelector("h2");
        const transactionSubmitButton = transactionDialog.querySelector('button[type="submit"]');
        const deleteUserButton = document.getElementById("delete-user");

        document.getElementById("open-add-user").addEventListener("click", () => {
            userForm.reset();
            userDialog.showModal();
        });

        document.getElementById("cancel-user").addEventListener("click", () => userDialog.close());

        document.getElementById("open-add-transaction").addEventListener("click", () => {
            if (!state.selectedUserId) return;
            openTransactionDialog("create");
        });

        document.getElementById("cancel-transaction").addEventListener("click", () => transactionDialog.close());
        deleteUserButton.addEventListener("click", handleDeleteUser);

        userForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const formData = new FormData(userForm);
            const payload = Object.fromEntries(formData.entries());

            payload.creances = parseNumberOrZero(payload.creances);
            payload.dettes = parseNumberOrZero(payload.dettes);
            if (payload.argent_recolte) {
                payload.argent_recolte = parseNumberOrZero(payload.argent_recolte);
            } else {
                payload.argent_recolte = payload.creances - payload.dettes;
            }
            payload.created_at = new Date().toISOString();
            payload.updated_at = payload.created_at;

            try {
                const created = await apiFetch("/users", {
                    method: "POST",
                    body: JSON.stringify(payload),
                });
                userDialog.close();
                await loadUsers();
                if (created && created._id) {
                    await selectUser(created._id);
                }
            } catch (error) {
                alert("Erreur lors de la création : " + error.message);
            }
        });

        transactionsContainer.addEventListener("click", (event) => {
            const target = event.target;
            if (target.closest(".transaction-edit")) {
                const button = target.closest(".transaction-edit");
                const transactionId = button.dataset.transactionId;
                const transaction = state.transactions.find((t) => t._id === transactionId);
                if (transaction) {
                    openTransactionDialog("edit", transaction);
                }
            } else if (target.closest(".transaction-delete")) {
                const button = target.closest(".transaction-delete");
                const transactionId = button.dataset.transactionId;
                handleDeleteTransaction(transactionId);
            }
        });

        transactionForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            if (!state.selectedUserId) return;

            const mode = transactionForm.dataset.mode || "create";
            const formData = new FormData(transactionForm);
            const transactionPayload = collectTransactionFormData(formData);

            try {
                if (mode === "edit") {
                    const transactionId = transactionForm.dataset.transactionId;
                    await apiFetch(`/transactions/${transactionId}`, {
                        method: "PUT",
                        body: JSON.stringify(transactionPayload),
                    });
                } else {
                    const currentUser = state.currentUser;
                    if (!currentUser) {
                        alert("Utilisateur introuvable en mémoire.");
                        return;
                    }
                    const payload = { transaction: transactionPayload };
                    Object.assign(payload, computeUserTotals(currentUser, transactionPayload));

                    await apiFetch(`/users/${state.selectedUserId}/transaction`, {
                        method: "PUT",
                        body: JSON.stringify(payload),
                    });
                }

                transactionDialog.close();
                await refreshCurrentUser();
            } catch (error) {
                alert("Erreur lors de l'enregistrement : " + error.message);
            }
        });

        async function loadUsers() {
            const users = await apiFetch("/users");
            state.users = users;
            renderUserList();
        }

        function renderUserList() {
            userListEl.innerHTML = "";
            if (!state.users.length) {
                const empty = document.createElement("li");
                empty.className = "muted";
                empty.textContent = "Aucun utilisateur";
                empty.style.cursor = "default";
                userListEl.appendChild(empty);
                userDetailsSection.hidden = true;
                userOverview.hidden = false;
                renderTransactions([]);
                return;
            }

            state.users.forEach((user) => {
                const li = document.createElement("li");
                li.textContent = `${user.first_name ?? ""} ${user.last_name ?? ""}`.trim() || user.email;
                if (user._id === state.selectedUserId) {
                    li.classList.add("active");
                }
                li.addEventListener("click", () => selectUser(user._id));
                userListEl.appendChild(li);
            });
        }

        async function selectUser(userId) {
            state.selectedUserId = userId;
            renderUserList();
            await refreshCurrentUser();
        }

        async function refreshCurrentUser() {
            if (!state.selectedUserId) {
                state.currentUser = null;
                state.transactions = [];
                renderTransactions([]);
                updateUserDetails(null);
                return;
            }

            try {
                const [user, transactions] = await Promise.all([
                    apiFetch(`/users/${state.selectedUserId}`),
                    apiFetch(`/transactions?user_id=${encodeURIComponent(state.selectedUserId)}`),
                ]);

                state.currentUser = user;
                state.transactions = transactions;

                updateUserDetails(user);
                renderTransactions(transactions);

                state.users = state.users.map((u) => (u._id === user._id ? user : u));
                renderUserList();
            } catch (error) {
                alert("Impossible de charger l'utilisateur : " + error.message);
            }
        }

        function updateUserDetails(user) {
            if (!user) {
                userDetailsSection.hidden = true;
                userOverview.hidden = false;
                return;
            }

            userDetailsSection.hidden = false;
            userOverview.hidden = true;

            document.getElementById("user-name").textContent =
                `${user.first_name ?? ""} ${user.last_name ?? ""}`.trim() || "Profil";
            document.getElementById("user-email").textContent = user.email || "Email inconnu";
            document.getElementById("user-phone").textContent = user.phone || "—";
            document.getElementById("user-creances").textContent = formatCurrency(user.creances);
            document.getElementById("user-dettes").textContent = formatCurrency(user.dettes);
            document.getElementById("user-argent").textContent = formatCurrency(user.argent_recolte);
            document.getElementById("user-created").textContent = formatDate(user.created_at);
            document.getElementById("user-updated").textContent = formatDate(user.updated_at);
        }

        function renderTransactions(transactions) {
            transactionsContainer.innerHTML = "";
            if (!transactions || !transactions.length) {
                const empty = document.createElement("div");
                empty.className = "empty-state";
                empty.textContent = "Aucune transaction enregistrée pour le moment.";
                transactionsContainer.appendChild(empty);
                return;
            }

            transactions.forEach((transaction) => {
                const item = document.createElement("div");
                item.className = `transaction-item ${transaction.type === "debit" ? "debit" : "credit"}`;
                item.innerHTML = `
                    <strong>${(transaction.relation_type || "").toUpperCase()} • ${(transaction.type || "").toUpperCase()}</strong>
                    <p>Montant : ${formatCurrency(transaction.amount)}</p>
                    <p>Catégorie : ${transaction.category_id ?? "—"}</p>
                    <p>${transaction.description ?? ""}</p>
                    <p class="muted">${formatDate(transaction.date)}</p>
                `;

                const actions = document.createElement("div");
                actions.className = "transaction-actions";
                const editButton = document.createElement("button");
                editButton.type = "button";
                editButton.className = "secondary transaction-edit";
                editButton.dataset.transactionId = transaction._id;
                editButton.textContent = "Modifier";
                actions.appendChild(editButton);
                const deleteButton = document.createElement("button");
                deleteButton.type = "button";
                deleteButton.className = "secondary transaction-delete";
                deleteButton.dataset.transactionId = transaction._id;
                deleteButton.textContent = "Supprimer";
                actions.appendChild(deleteButton);

                item.appendChild(actions);
                transactionsContainer.appendChild(item);
            });
        }

        function openTransactionDialog(mode, transaction = null) {
            transactionForm.reset();
            transactionForm.dataset.mode = mode;
            transactionForm.dataset.transactionId = transaction?._id || "";

            if (mode === "edit" && transaction) {
                transactionTitleEl.textContent = "Modifier la transaction";
                transactionSubmitButton.textContent = "Mettre à jour";
                transactionForm.elements.relation_type.value = transaction.relation_type || "creance";
                transactionForm.elements.type.value = transaction.type || "credit";
                transactionForm.elements.amount.value = parseNumberOrZero(transaction.amount);
                transactionForm.elements.description.value = transaction.description ?? "";
                transactionForm.elements.category_id.value = transaction.category_id ?? "";
                const dateValue = transaction.date ? new Date(transaction.date) : new Date();
                transactionForm.elements.date.value = toLocalInputDateTime(dateValue);
            } else {
                transactionTitleEl.textContent = "Nouvelle transaction";
                transactionSubmitButton.textContent = "Valider";
                const now = new Date();
                transactionForm.elements.date.value = toLocalInputDateTime(now);
            }

            transactionDialog.showModal();
        }

        function collectTransactionFormData(formData) {
            const amount = parseNumberOrZero(formData.get("amount"));
            const categoryIdRaw = (formData.get("category_id") || "").trim();

            const data = {
                relation_type: formData.get("relation_type"),
                type: formData.get("type"),
                amount,
                description: formData.get("description") || null,
                date: (() => {
                    const dateValue = formData.get("date");
                    return dateValue ? new Date(dateValue).toISOString() : new Date().toISOString();
                })(),
            };

            if (categoryIdRaw) {
                data.category_id = categoryIdRaw;
            } else {
                data.category_id = null;
            }

            return data;
        }

        function computeUserTotals(user, transaction) {
            const result = {
                updated_at: new Date().toISOString(),
            };

            const amount = transaction.amount;
            let creances = parseNumberOrZero(user.creances);
            let dettes = parseNumberOrZero(user.dettes);

            if (transaction.relation_type === "creance") {
                creances = transaction.type === "credit" ? creances + amount : creances - amount;
            } else if (transaction.relation_type === "dette") {
                dettes = transaction.type === "credit" ? dettes + amount : dettes - amount;
            }

            result.creances = roundToTwo(creances);
            result.dettes = roundToTwo(dettes);
            result.argent_recolte = roundToTwo(result.creances - result.dettes);
            return result;
        }

        async function apiFetch(path, options = {}) {
            const response = await fetch(`${API_BASE_URL}${path}`, {
                headers: { "Content-Type": "application/json" },
                ...options,
            });
            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({}));
                const message = errorBody.error || response.statusText || "Erreur réseau";
                throw new Error(message);
            }
            return response.json();
        }

        function parseNumberOrZero(value) {
            const parsed = Number.parseFloat(value);
            return Number.isFinite(parsed) ? parsed : 0;
        }

        function roundToTwo(value) {
            return Math.round(value * 100) / 100;
        }

        function formatCurrency(value) {
            const number = parseNumberOrZero(value);
            return new Intl.NumberFormat("fr-FR", { style: "currency", currency: "EUR" }).format(number);
        }

        function formatDate(value) {
            if (!value) return "—";
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return value;
            return date.toLocaleString("fr-FR");
        }

        function toLocalInputDateTime(date) {
            const pad = (n) => n.toString().padStart(2, "0");
            const yyyy = date.getFullYear();
            const mm = pad(date.getMonth() + 1);
            const dd = pad(date.getDate());
            const hh = pad(date.getHours());
            const min = pad(date.getMinutes());
            return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
        }

        async function handleDeleteUser() {
            if (!state.selectedUserId) {
                return;
            }
            const user = state.currentUser;
            const label = user
                ? `${user.first_name ?? ""} ${user.last_name ?? ""}`.trim() || user.email || "cet utilisateur"
                : "cet utilisateur";
            const confirmation = window.confirm(`Supprimer ${label} ? Cette action est définitive.`);
            if (!confirmation) {
                return;
            }
            try {
                await apiFetch(`/users/${state.selectedUserId}`, {
                    method: "DELETE",
                });
                state.selectedUserId = null;
                state.currentUser = null;
                state.transactions = [];
                await loadUsers();
                updateUserDetails(null);
                renderTransactions([]);
            } catch (error) {
                alert("Impossible de supprimer l'utilisateur : " + error.message);
            }
        }

        async function handleDeleteTransaction(transactionId) {
            if (!transactionId || !state.selectedUserId) {
                return;
            }
            const confirmation = window.confirm("Supprimer cette transaction ? Cette action est définitive.");
            if (!confirmation) {
                return;
            }
            try {
                const response = await apiFetch(`/transactions/${transactionId}`, {
                    method: "DELETE",
                });

                if (response && response.user) {
                    state.currentUser = response.user;
                    state.users = state.users.map((u) => (u._id === response.user._id ? response.user : u));
                    updateUserDetails(response.user);
                }

                state.transactions = state.transactions.filter((t) => t._id !== transactionId);
                renderTransactions(state.transactions);
            } catch (error) {
                alert("Impossible de supprimer la transaction : " + error.message);
            }
        }

        loadUsers().catch((error) => {
            console.error(error);
            alert("Impossible de charger les utilisateurs : " + error.message);
        });
    </script>
</body>
</html>
