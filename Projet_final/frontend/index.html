<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker - Console</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="login-view" class="login-view">
        <form id="login-form" class="login-card">
            <h1>Connexion administrateur</h1>
            <p>Connecte-toi pour accéder au tableau de bord.</p>
            <label>Nom d'utilisateur
                <input type="text" name="username" autocomplete="username" required>
            </label>
            <label>Mot de passe
                <input type="password" name="password" autocomplete="current-password" required>
            </label>
            <p id="login-error" class="login-error"></p>
            <button type="submit">Se connecter</button>
        </form>
    </div>

    <div id="app-root" class="app hidden">
        <aside>
            <div>
                <h2>Utilisateurs</h2>
                <button id="open-add-user">Ajouter</button>
            </div>
            <ul id="user-list" class="user-list"></ul>
        </aside>
        <main>
            <header class="top-bar">
                <div class="top-info">
                    <h1>Console de test</h1>
                    <p class="muted">Gère les utilisateurs, leurs transactions et les rapports financiers.</p>
                </div>
                <div class="top-actions">
                    <button id="notification-toggle" class="icon-button" type="button">
                        Notifications
                        <span id="notification-badge" class="badge pill hidden"></span>
                    </button>
                    <button id="logout-button" class="secondary" type="button">Déconnexion</button>
                </div>
            </header>

            <nav class="subnav">
                <button type="button" data-section="users" class="active">Utilisateurs</button>
                <button type="button" data-section="categories">Catégories</button>
                <button type="button" data-section="reports">Rapports</button>
                <button type="button" data-section="transactions">Transactions</button>
                <button type="button" data-section="admins">Administrateurs</button>
            </nav>

            <section id="user-overview" class="card">
                <h2>Bienvenue</h2>
                <p class="muted">
                    Sélectionne un utilisateur pour afficher ses informations et enregistrer de nouvelles transactions.
                    Utilise le bouton « Ajouter » pour créer un profil de test.
                </p>
            </section>

            <section id="user-details" class="card" hidden>
                <header style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
                    <div>
                        <h2 id="user-name">Utilisateur</h2>
                        <p id="user-email" class="muted"></p>
                    </div>
                    <div style="display:flex;gap:0.5rem;">
                        <button id="open-edit-user" class="secondary" disabled>Modifier</button>
                        <button id="open-add-transaction">Ajouter une transaction</button>
                        <button id="delete-user" class="secondary">Supprimer</button>
                    </div>
                </header>
                <div id="user-meta">
                    <p><span class="badge">Téléphone</span><span id="user-phone">-</span></p>
                    <p><span class="badge">Créances</span><span id="user-creances">0</span></p>
                    <p><span class="badge">Dettes</span><span id="user-dettes">0</span></p>
                    <p><span class="badge">Argent récolté</span><span id="user-argent">0</span></p>
                    <p class="muted" style="margin-top:0.75rem;">
                        <strong>Créé le</strong> <span id="user-created"></span>
                        &nbsp;•&nbsp;<strong>Mis à jour</strong> <span id="user-updated"></span>
                    </p>
                </div>
                <div>
                    <h3>Transactions</h3>
                    <div id="transactions" class="transactions"></div>
                </div>
            </section>

            <section id="category-section" class="card" hidden>
                <header style="display:flex;justify-content:space-between;align-items:center;">
                    <h2>Catégories</h2>
                    <button id="open-add-category">Ajouter</button>
                </header>
                <p class="muted">Gère les catégories utilisées lors de la création ou modification d'une transaction.</p>
                <ul id="category-list" class="category-list"></ul>
            </section>

            <section id="reports-section" class="card" hidden>
                <header>
                    <h2>Rapports financiers</h2>
                </header>
                <p class="muted">
                    Sélectionne une période, puis génère un rapport pour chaque utilisateur afin de visualiser leurs créances,
                    dettes et l'argent récolté.
                </p>
                <form id="report-form" class="report-controls">
                    <label>Période début
                        <input type="datetime-local" name="period_start" required>
                    </label>
                    <label>Période fin
                        <input type="datetime-local" name="period_end" required>
                    </label>
                    <button type="submit" id="generate-reports">Générer les rapports</button>
                </form>
                <p id="report-status" class="muted report-status"></p>
                <div id="report-history-wrapper" class="report-history-wrapper">
                    <h3>Historique des rapports</h3>
                    <p id="report-history-empty" class="muted">Aucun rapport enregistré pour le moment.</p>
                    <ul id="report-history-list" class="report-history-list"></ul>
                </div>
                <div id="report-detail" class="report-detail" hidden>
                    <div class="report-detail-header">
                        <div>
                            <h3 id="report-detail-title">Rapport sélectionné</h3>
                            <p id="report-detail-subtitle" class="muted"></p>
                        </div>
                        <button type="button" class="secondary" id="report-back">Retour</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Utilisateur</th>
                                    <th>Créances</th>
                                    <th>Dettes</th>
                                    <th>Argent récolté</th>
                                </tr>
                            </thead>
                            <tbody id="report-table-body">
                                <tr>
                                    <td colspan="4" class="muted">Sélectionne un rapport dans l'historique pour afficher les détails.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="transactions-section" class="card" hidden>
                <header style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <h2>Toutes les transactions</h2>
                        <p class="muted">Filtre et parcours l'ensemble des transactions enregistrées.</p>
                    </div>
                    <div class="report-controls" style="margin-top:0;">
                        <label>Catégorie
                            <select id="all-transactions-category">
                                <option value="">Toutes</option>
                            </select>
                        </label>
                        <label>Date min
                            <input type="date" id="all-transactions-from">
                        </label>
                        <label>Date max
                            <input type="date" id="all-transactions-to">
                        </label>
                        <label>Tri
                            <select id="all-transactions-sort">
                                <option value="date_desc">Date décroissante</option>
                                <option value="date_asc">Date croissante</option>
                                <option value="category_asc">Catégorie (A → Z)</option>
                                <option value="category_desc">Catégorie (Z → A)</option>
                            </select>
                        </label>
                        <button type="button" id="all-transactions-reset" class="secondary">Réinitialiser</button>
                    </div>
                </header>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Utilisateur</th>
                                <th>Relation</th>
                                <th>Type</th>
                                <th>Montant</th>
                                <th>Catégorie</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="all-transactions-table">
                            <tr>
                                <td colspan="7" class="muted">Aucune transaction à afficher.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="admins-section" class="card" hidden>
                <header style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <h2>Administration</h2>
                        <p class="muted">Gère ton profil administrateur et les autres comptes.</p>
                    </div>
                    <button id="open-add-admin">Créer un administrateur</button>
                </header>

                <div class="card" style="margin-top:1.25rem;">
                    <h3>Mon profil</h3>
                    <form id="admin-profile-form" class="admin-profile-form">
                        <div class="form-grid">
                            <label>Nom d'utilisateur
                                <input type="text" name="username" id="admin-username" required>
                            </label>
                            <label>Email
                                <input type="email" name="email" id="admin-email" required>
                            </label>
                        </div>
                        <div class="form-grid">
                            <label>Mot de passe actuel
                                <input type="password" name="current_password" autocomplete="current-password" placeholder="Obligatoire pour changer le mot de passe">
                            </label>
                            <label>Nouveau mot de passe
                                <input type="password" name="new_password" autocomplete="new-password" placeholder="Laisse vide pour conserver l'actuel">
                            </label>
                        </div>
                        <div class="actions">
                            <button type="submit">Mettre à jour</button>
                        </div>
                    </form>
                </div>

                <div class="card" style="margin-top:1.25rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <h3>Autres administrateurs</h3>
                        <span id="admin-count" class="muted"></span>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom d'utilisateur</th>
                                    <th>Email</th>
                                    <th>Rôle</th>
                                    <th>Créé le</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-table-body">
                                <tr>
                                    <td colspan="5" class="muted">Aucun autre administrateur enregistré.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="notification-panel" class="notification-panel hidden">
        <div class="notification-header">
            <h2>Notifications</h2>
            <div class="notification-header-actions">
                <button id="refresh-notifications" class="secondary small" type="button">Rafraîchir</button>
                <button id="clear-notifications" class="secondary small" type="button">Tout supprimer</button>
                <button id="close-notifications" class="icon-button small" type="button">Fermer</button>
            </div>
        </div>
        <ul id="notification-list" class="notification-list"></ul>
    </div>

    <dialog id="user-dialog">
        <form id="user-form">
            <h2>Nouvel utilisateur</h2>
            <label>Prénom
                <input type="text" name="first_name" required>
            </label>
            <label>Nom
                <input type="text" name="last_name" required>
            </label>
            <label>Email
                <input type="email" name="email" required>
            </label>
            <label>Téléphone
                <input type="text" name="phone">
            </label>
            <label>Créances initiales
                <input type="number" step="0.01" min="0" name="creances" value="0">
            </label>
            <label>Dettes initiales
                <input type="number" step="0.01" min="0" name="dettes" value="0">
            </label>
            <label>Argent récolté
                <input type="number" step="0.01" name="argent_recolte" placeholder="Laisse vide pour auto-calcul">
            </label>
            <div class="actions">
                <button type="button" class="secondary" id="cancel-user">Annuler</button>
                <button type="submit">Enregistrer</button>
            </div>
        </form>
    </dialog>

    <dialog id="transaction-dialog">
        <form id="transaction-form">
            <h2>Ajouter une transaction</h2>
            <label>Type de relation
                <select name="relation_type" required>
                    <option value="creance">Créance</option>
                    <option value="dette">Dette</option>
                </select>
            </label>
            <label>Sens de la transaction
                <select name="type" required>
                    <option value="credit">Crédit (ajout)</option>
                    <option value="debit">Débit (retrait)</option>
                </select>
            </label>
            <label>Montant (€)
                <input type="number" name="amount" min="0" step="0.01" required>
            </label>
            <label>Description
                <textarea name="description" rows="3" placeholder="Ex: Remboursement partiel"></textarea>
            </label>
            <label>Catégorie
                <select name="category_id" id="transaction-category">
                    <option value="">Sans catégorie</option>
                </select>
            </label>
            <label>Date
                <input type="datetime-local" name="date">
            </label>
            <div class="actions">
                <button type="button" class="secondary" id="cancel-transaction">Annuler</button>
                <button type="submit">Valider</button>
            </div>
        </form>
    </dialog>

    <dialog id="category-dialog">
        <form id="category-form">
            <h2>Nouvelle catégorie</h2>
            <label>Nom
                <input type="text" name="name" required>
            </label>
            <label>Description
                <textarea name="description" rows="3" placeholder="Détail optionnel"></textarea>
            </label>
            <div class="actions">
                <button type="button" class="secondary" id="cancel-category">Annuler</button>
                <button type="submit">Enregistrer</button>
            </div>
        </form>
    </dialog>

    <dialog id="admin-dialog">
        <form id="admin-form">
            <h2>Nouvel administrateur</h2>
            <label>Nom d'utilisateur
                <input type="text" name="username" required>
            </label>
            <label>Email
                <input type="email" name="email" required>
            </label>
            <label>Mot de passe
                <input type="password" name="password" required>
            </label>
            <label>Rôle
                <select name="role">
                    <option value="admin">Administrateur</option>
                </select>
            </label>
            <div class="actions">
                <button type="button" class="secondary" id="cancel-admin">Annuler</button>
                <button type="submit">Créer</button>
            </div>
        </form>
    </dialog>

    <script src="app.js"></script>
</body>
</html>
